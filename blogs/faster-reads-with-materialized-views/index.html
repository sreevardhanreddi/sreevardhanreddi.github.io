<!doctype html><html lang=en><head><title>Faster Reads With Materialized Views ::
sreevardhanreddi.github.io — Software Developer</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="This Blog aims to give you a gist of Views in PostgreSQL and how to integrate in Django.
PostgreSQL Views are quite handy, think of Views as wrapping(abstracting) your complex queries and assigning a name to them.
They are several benifits of using Views, here are few
Views hide the complexity
if you have a query that requires aggregating or joining multiple tables and has complex logic, you can code all that logic into a view and then retreive data from it as if it were a normal table."><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=https://sreevardhanreddi.github.io/blogs/faster-reads-with-materialized-views/><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=https://sreevardhanreddi.github.io/style.css><link rel=apple-touch-icon-precomposed sizes=144x144 href=https://sreevardhanreddi.github.io/img/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=https://sreevardhanreddi.github.io/img/favicon.png><link href=/fonts/Inter-Italic.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=/fonts/Inter-Regular.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=/fonts/Inter-Medium.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=/fonts/Inter-MediumItalic.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=/fonts/Inter-Bold.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=/fonts/Inter-BoldItalic.woff2 rel=preload type=font/woff2 as=font crossorigin><meta name=twitter:card content="summary"><meta name=twitter:title content="Faster Reads With Materialized Views"><meta name=twitter:description content="This Blog aims to give you a gist of Views in PostgreSQL and how to integrate in Django.
PostgreSQL Views are quite handy, think of Views as wrapping(abstracting) your complex queries and assigning a name to them.
They are several benifits of using Views, here are few
Views hide the complexity
if you have a query that requires aggregating or joining multiple tables and has complex logic, you can code all that logic into a view and then retreive data from it as if it were a normal table."><meta property="og:title" content="Faster Reads With Materialized Views"><meta property="og:description" content="This Blog aims to give you a gist of Views in PostgreSQL and how to integrate in Django.
PostgreSQL Views are quite handy, think of Views as wrapping(abstracting) your complex queries and assigning a name to them.
They are several benifits of using Views, here are few
Views hide the complexity
if you have a query that requires aggregating or joining multiple tables and has complex logic, you can code all that logic into a view and then retreive data from it as if it were a normal table."><meta property="og:type" content="article"><meta property="og:url" content="https://sreevardhanreddi.github.io/blogs/faster-reads-with-materialized-views/"><meta property="article:section" content="blogs"><meta property="article:published_time" content="2021-08-12T16:26:31+05:30"><meta property="article:modified_time" content="2021-08-12T16:26:31+05:30"><meta property="og:site_name" content="sreevardhanreddi.github.io"></head><body class=dark-theme><div class=container><header class=header><span class=header__inner><a href=/ class=logo style=text-decoration:none><span class=logo__mark><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg></span><span class=logo__text>developer</span>
<span class=logo__cursor></span></a>
<span class=header__right><nav class=menu><ul class="menu__inner menu__inner--desktop"><li><a href=/>/</a></li><li><a href=/blogs>Blogs</a></li></ul><ul class="menu__inner menu__inner--mobile"><li><a href=/>/</a></li><li><a href=/blogs>Blogs</a></li></ul></nav><span class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></span><span class=theme-toggle><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 41c10.4934.0 19-8.5066 19-19C41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22s8.5066 19 19 19zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"/></svg></span></span></span></header><div class=content><article class=post><h1 class=post-title>Faster Reads With Materialized Views</h1><div class=post-meta><time class=post-date>2021-08-12</time>
<span class=post-read-time>— 6 min read</span></div><span class=post-tags><a href=https://sreevardhanreddi.github.io/tags/postgres/>#Postgres</a>&nbsp;
<a href=https://sreevardhanreddi.github.io/tags/django/>#Django</a>&nbsp;
<a href=https://sreevardhanreddi.github.io/tags/python/>#python</a>&nbsp;</span><div class=post-content><p>This Blog aims to give you a gist of Views in PostgreSQL and how to integrate in Django.</p><p>PostgreSQL Views are quite handy, think of Views as wrapping(abstracting) your complex queries and assigning a name to them.</p><p>They are several benifits of using Views, here are few</p><ul><li><p>Views hide the complexity</p><p>if you have a query that requires aggregating or joining multiple tables and has complex logic, you can code all that logic into a view
and then retreive data from it as if it were a normal table.</p></li><li><p>Views could be used for security</p><p>imagine you have a table with sensitive data in certain columns/rows and you want to give access to a user without exposing that data, views allow us to wrap only the required data and grant permission to that view instead of underlying table.</p></li></ul><p>Like all the SQL databases postgres has two kinds of views</p><ul><li>Views</li><li>Materialized Views</li></ul><p>Here are few differences between Views and Materialized Views</p><table><thead><tr><th>Views</th><th>Materialized Views</th></tr></thead><tbody><tr><td>Views are not stored in the disk.</td><td>Materiliazed Views are stored on the disk.</td></tr><tr><td>Whenever we read data from views, data is read from the underlying table.</td><td>Since materialized views has its own table, reading from materialized views will read from the table directly, but not from the underlying table.</td></tr></tbody></table><p>Let us try to implement Materialized Views. Consider a following scenario of a Blogging site. A typical Blogging site models would contain</p><ul><li>blogs table</li><li>categories table</li><li>tags table</li></ul><p>where the relationship between them is quite straightforward, blogs has <strong>foreign key</strong> to categories and has a <strong>many to many</strong> relationship with tags. The equivalent Django Models would look like this.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Tags</span>(models<span style=color:#f92672>.</span>Model):
</span></span><span style=display:flex><span>    name <span style=color:#f92672>=</span> models<span style=color:#f92672>.</span>CharField(max_length<span style=color:#f92672>=</span><span style=color:#ae81ff>200</span>, unique<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Meta</span>:
</span></span><span style=display:flex><span>        verbose_name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Tag&#34;</span>
</span></span><span style=display:flex><span>        verbose_name_plural <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Tags&#34;</span>
</span></span><span style=display:flex><span>        db_table <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;tags&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __str__(self):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> self<span style=color:#f92672>.</span>name
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Category</span>(models<span style=color:#f92672>.</span>Model):
</span></span><span style=display:flex><span>    name <span style=color:#f92672>=</span> models<span style=color:#f92672>.</span>CharField(max_length<span style=color:#f92672>=</span><span style=color:#ae81ff>200</span>, unique<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Meta</span>:
</span></span><span style=display:flex><span>        verbose_name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Category&#34;</span>
</span></span><span style=display:flex><span>        verbose_name_plural <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Categories&#34;</span>
</span></span><span style=display:flex><span>        db_table <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;categories&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __str__(self):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> self<span style=color:#f92672>.</span>name
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Blog</span>(models<span style=color:#f92672>.</span>Model):
</span></span><span style=display:flex><span>    title <span style=color:#f92672>=</span> models<span style=color:#f92672>.</span>CharField(max_length<span style=color:#f92672>=</span><span style=color:#ae81ff>200</span>, unique<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>)
</span></span><span style=display:flex><span>    content <span style=color:#f92672>=</span> models<span style=color:#f92672>.</span>TextField()
</span></span><span style=display:flex><span>    created_at <span style=color:#f92672>=</span> models<span style=color:#f92672>.</span>DateTimeField(auto_now<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>)
</span></span><span style=display:flex><span>    is_published <span style=color:#f92672>=</span> models<span style=color:#f92672>.</span>BooleanField(default<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>)
</span></span><span style=display:flex><span>    category <span style=color:#f92672>=</span> models<span style=color:#f92672>.</span>ForeignKey(Category, on_delete<span style=color:#f92672>=</span>models<span style=color:#f92672>.</span>SET_NULL, null<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>)
</span></span><span style=display:flex><span>    tags <span style=color:#f92672>=</span> models<span style=color:#f92672>.</span>ManyToManyField(Tags)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Meta</span>:
</span></span><span style=display:flex><span>        verbose_name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Blog&#34;</span>
</span></span><span style=display:flex><span>        verbose_name_plural <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Blogs&#34;</span>
</span></span><span style=display:flex><span>        db_table <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;blogs&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __str__(self):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> self<span style=color:#f92672>.</span>title
</span></span></code></pre></div><p>Let&rsquo;s assume a situation where we have to query all the three tables and get data from all the three tables, for us to achieve this we&rsquo;ll have to join all the tables, the resulting django query would look like this</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>queryset <span style=color:#f92672>=</span> Blog<span style=color:#f92672>.</span>objects<span style=color:#f92672>.</span>select_related(<span style=color:#e6db74>&#34;category&#34;</span>)<span style=color:#f92672>.</span>prefetch_related(<span style=color:#e6db74>&#34;tags&#34;</span>)<span style=color:#f92672>.</span>all()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># the resulting SQL query generated by Django ORM is</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>SELECT <span style=color:#e6db74>&#34;blogs&#34;</span><span style=color:#f92672>.</span><span style=color:#e6db74>&#34;id&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;blogs&#34;</span><span style=color:#f92672>.</span><span style=color:#e6db74>&#34;title&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;blogs&#34;</span><span style=color:#f92672>.</span><span style=color:#e6db74>&#34;content&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;blogs&#34;</span><span style=color:#f92672>.</span><span style=color:#e6db74>&#34;created_at&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;blogs&#34;</span><span style=color:#f92672>.</span><span style=color:#e6db74>&#34;is_published&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;blogs&#34;</span><span style=color:#f92672>.</span><span style=color:#e6db74>&#34;category_id&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;categories&#34;</span><span style=color:#f92672>.</span><span style=color:#e6db74>&#34;id&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;categories&#34;</span><span style=color:#f92672>.</span><span style=color:#e6db74>&#34;name&#34;</span>
</span></span><span style=display:flex><span>FROM <span style=color:#e6db74>&#34;blogs&#34;</span>
</span></span><span style=display:flex><span>LEFT OUTER JOIN <span style=color:#e6db74>&#34;categories&#34;</span>
</span></span><span style=display:flex><span>ON (<span style=color:#e6db74>&#34;blogs&#34;</span><span style=color:#f92672>.</span><span style=color:#e6db74>&#34;category_id&#34;</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;categories&#34;</span><span style=color:#f92672>.</span><span style=color:#e6db74>&#34;id&#34;</span>)
</span></span><span style=display:flex><span>LIMIT <span style=color:#ae81ff>21</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>SELECT (<span style=color:#e6db74>&#34;blogs_tags&#34;</span><span style=color:#f92672>.</span><span style=color:#e6db74>&#34;blog_id&#34;</span>) AS <span style=color:#e6db74>&#34;_prefetch_related_val_blog_id&#34;</span>,
</span></span><span style=display:flex><span>       <span style=color:#e6db74>&#34;tags&#34;</span><span style=color:#f92672>.</span><span style=color:#e6db74>&#34;id&#34;</span>,
</span></span><span style=display:flex><span>       <span style=color:#e6db74>&#34;tags&#34;</span><span style=color:#f92672>.</span><span style=color:#e6db74>&#34;name&#34;</span>
</span></span><span style=display:flex><span>  FROM <span style=color:#e6db74>&#34;tags&#34;</span>
</span></span><span style=display:flex><span> INNER JOIN <span style=color:#e6db74>&#34;blogs_tags&#34;</span>
</span></span><span style=display:flex><span>    ON (<span style=color:#e6db74>&#34;tags&#34;</span><span style=color:#f92672>.</span><span style=color:#e6db74>&#34;id&#34;</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;blogs_tags&#34;</span><span style=color:#f92672>.</span><span style=color:#e6db74>&#34;tags_id&#34;</span>)
</span></span><span style=display:flex><span> WHERE <span style=color:#e6db74>&#34;blogs_tags&#34;</span><span style=color:#f92672>.</span><span style=color:#e6db74>&#34;blog_id&#34;</span> IN (<span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>3</span>, <span style=color:#ae81ff>4</span>, <span style=color:#ae81ff>5</span>, <span style=color:#ae81ff>6</span>, <span style=color:#ae81ff>7</span>, <span style=color:#ae81ff>8</span>, <span style=color:#ae81ff>9</span>, <span style=color:#ae81ff>10</span>, <span style=color:#ae81ff>11</span>, <span style=color:#ae81ff>12</span>, <span style=color:#ae81ff>13</span>, <span style=color:#ae81ff>14</span>, <span style=color:#ae81ff>15</span>, <span style=color:#ae81ff>16</span>, <span style=color:#ae81ff>17</span>, <span style=color:#ae81ff>18</span>, <span style=color:#ae81ff>19</span>, <span style=color:#ae81ff>20</span>, <span style=color:#ae81ff>21</span>)
</span></span></code></pre></div><p>Notice that Django actually performs two queries here, we can do better by writing our own query :)</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> b.id,
</span></span><span style=display:flex><span>       b.title <span style=color:#66d9ef>AS</span> blog_title,
</span></span><span style=display:flex><span>       b.created_at <span style=color:#66d9ef>AS</span> blog_created_at,
</span></span><span style=display:flex><span>       b.is_published <span style=color:#66d9ef>AS</span> blog_is_published,
</span></span><span style=display:flex><span>       b.category_id <span style=color:#66d9ef>AS</span> blog_category_id,
</span></span><span style=display:flex><span>       b.content <span style=color:#66d9ef>AS</span> blog_content,
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>c</span>.id <span style=color:#66d9ef>AS</span> category_id,
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>c</span>.name <span style=color:#66d9ef>AS</span> category_name,
</span></span><span style=display:flex><span>       bt.blog_id <span style=color:#66d9ef>AS</span> blog_tag_blog_id,
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>count</span>(t.id) <span style=color:#66d9ef>AS</span> tag_count,
</span></span><span style=display:flex><span>       jsonb_agg(jsonb_build_object(<span style=color:#e6db74>&#39;tag_id&#39;</span>, t.id, <span style=color:#e6db74>&#39;tag_name&#39;</span>, t.name)) <span style=color:#66d9ef>AS</span> tag_json
</span></span><span style=display:flex><span><span style=color:#66d9ef>FROM</span> blogs b
</span></span><span style=display:flex><span><span style=color:#66d9ef>LEFT</span> <span style=color:#66d9ef>JOIN</span> categories <span style=color:#66d9ef>c</span> <span style=color:#66d9ef>ON</span> b.category_id <span style=color:#f92672>=</span> <span style=color:#66d9ef>c</span>.id
</span></span><span style=display:flex><span><span style=color:#66d9ef>LEFT</span> <span style=color:#66d9ef>JOIN</span> blogs_tags bt <span style=color:#66d9ef>ON</span> b.id <span style=color:#f92672>=</span> bt.blog_id
</span></span><span style=display:flex><span><span style=color:#66d9ef>LEFT</span> <span style=color:#66d9ef>JOIN</span> tags t <span style=color:#66d9ef>ON</span> bt.tags_id <span style=color:#f92672>=</span> t.id
</span></span><span style=display:flex><span><span style=color:#66d9ef>GROUP</span> <span style=color:#66d9ef>BY</span> b.id,
</span></span><span style=display:flex><span>         <span style=color:#66d9ef>c</span>.id,
</span></span><span style=display:flex><span>         bt.blog_id
</span></span><span style=display:flex><span><span style=color:#66d9ef>ORDER</span> <span style=color:#66d9ef>BY</span> b.id;
</span></span></code></pre></div><p>As you can see the query is quite complex, we&rsquo;ll need to run the query every time when we need to access the data, thankfully views provide a convenient way to make it simple.</p><p>Let&rsquo;s see how we can create a Materialized Views</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> materialized <span style=color:#66d9ef>VIEW</span> mv_blogs_with_categories_and_tags_combined <span style=color:#66d9ef>AS</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> b.id,
</span></span><span style=display:flex><span>       b.title <span style=color:#66d9ef>AS</span> blog_title,
</span></span><span style=display:flex><span>       b.content <span style=color:#66d9ef>AS</span> blog_content,
</span></span><span style=display:flex><span>       b.created_at <span style=color:#66d9ef>AS</span> blog_created_at,
</span></span><span style=display:flex><span>       b.is_published <span style=color:#66d9ef>AS</span> blog_is_published,
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>c</span>.id <span style=color:#66d9ef>AS</span> category_id,
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>c</span>.name <span style=color:#66d9ef>AS</span> category_name,
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>count</span>(t.id) <span style=color:#66d9ef>AS</span> tag_count,
</span></span><span style=display:flex><span>       jsonb_agg(jsonb_build_object(<span style=color:#e6db74>&#39;tag_id&#39;</span>, t.id, <span style=color:#e6db74>&#39;tag_name&#39;</span>, t.name)) <span style=color:#66d9ef>AS</span> tags
</span></span><span style=display:flex><span><span style=color:#66d9ef>FROM</span> blogs b
</span></span><span style=display:flex><span><span style=color:#66d9ef>LEFT</span> <span style=color:#66d9ef>JOIN</span> categories <span style=color:#66d9ef>c</span> <span style=color:#66d9ef>ON</span> b.category_id <span style=color:#f92672>=</span> <span style=color:#66d9ef>c</span>.id
</span></span><span style=display:flex><span><span style=color:#66d9ef>LEFT</span> <span style=color:#66d9ef>JOIN</span> blogs_tags bt <span style=color:#66d9ef>ON</span> b.id <span style=color:#f92672>=</span> bt.blog_id
</span></span><span style=display:flex><span><span style=color:#66d9ef>LEFT</span> <span style=color:#66d9ef>JOIN</span> tags t <span style=color:#66d9ef>ON</span> bt.tags_id <span style=color:#f92672>=</span> t.id
</span></span><span style=display:flex><span><span style=color:#66d9ef>GROUP</span> <span style=color:#66d9ef>BY</span> b.id,
</span></span><span style=display:flex><span>         <span style=color:#66d9ef>c</span>.id,
</span></span><span style=display:flex><span>         bt.blog_id
</span></span><span style=display:flex><span><span style=color:#66d9ef>ORDER</span> <span style=color:#66d9ef>BY</span> b.id <span style=color:#66d9ef>WITH</span> <span style=color:#66d9ef>NO</span> <span style=color:#66d9ef>DATA</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>--- create a unique index, this is needed when we try to refresh the materialized view concurrently
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>UNIQUE</span> <span style=color:#66d9ef>INDEX</span> <span style=color:#66d9ef>ON</span> mv_blogs_with_categories_and_tags_combined (id);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>--- refresh the materialized view, to populate the data into it.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>REFRESH MATERIALIZED <span style=color:#66d9ef>VIEW</span> mv_blogs_with_categories_and_tags_combined;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>--- refresh the materialized view concurrently, without locking the table
</span></span></span><span style=display:flex><span><span style=color:#75715e>--- when we refresh the view without concurrently , a lock is acquired on the table
</span></span></span><span style=display:flex><span><span style=color:#75715e>--- to prevent this we use concurrently
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>REFRESH MATERIALIZED <span style=color:#66d9ef>VIEW</span> CONCURRENTLY mv_blogs_with_categories_and_tags_combined;
</span></span></code></pre></div><p>In the below screenshots you can see the execution times, when querying the materialized view table vs performing the complex query.</p><p><img src=https://raw.githubusercontent.com/sreevardhanreddi/django-materialized-views/master/docs/complex_query.png alt=without_materialized_views></p><pre tabindex=0><code>Execution Time: 25.874 ms
</code></pre><p><img src=https://raw.githubusercontent.com/sreevardhanreddi/django-materialized-views/master/docs/materialized_views.png alt=with_materialized_views></p><pre tabindex=0><code>Execution Time: 0.155 ms
</code></pre><h2 id=speed-up--160x>Speed Up ~ 160x
<a href=#speed-up--160x class=h-anchor aria-hidden=true>#</a></h2><p>All the code is available here in this repo <a href=https://github.com/sreevardhanreddi/django-materialized-views>https://github.com/sreevardhanreddi/django-materialized-views</a></p><hr><h2 id=integration-with-django>Integration With Django
<a href=#integration-with-django class=h-anchor aria-hidden=true>#</a></h2><p>Now that the SQL is done, let us go through integrating it with Django</p><p>Create an empty migrations file using this command</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>python manage.py makemigrations --name materialized_blogs pg_app --empty
</span></span></code></pre></div><p>This file that is generated is used to create the migrations using Django&rsquo;s <strong>migrate</strong> command and it like show below</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Generated by Django 3.2.6 on 2021-08-12 06:59</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> django.db <span style=color:#f92672>import</span> migrations
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> django.db.migrations.operations.special <span style=color:#f92672>import</span> RunSQL
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Migration</span>(migrations<span style=color:#f92672>.</span>Migration):
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    dependencies <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>        (<span style=color:#e6db74>&#34;pg_app&#34;</span>, <span style=color:#e6db74>&#34;0001_initial&#34;</span>),
</span></span><span style=display:flex><span>    ]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    operations <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>        migrations<span style=color:#f92672>.</span>RunSQL(
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            CREATE materialized VIEW mv_blogs_with_categories_and_tags_combined AS
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            SELECT b.id,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                b.title AS blog_title,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                b.content AS blog_content,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                b.created_at AS blog_created_at,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                b.is_published AS blog_is_published,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                c.id AS category_id,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                c.name AS category_name,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                count(t.id) AS tag_count,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                jsonb_agg(jsonb_build_object(&#39;tag_id&#39;, t.id, &#39;tag_name&#39;, t.name)) AS tags
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            FROM blogs b
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            LEFT JOIN categories c ON b.category_id = c.id
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            LEFT JOIN blogs_tags bt ON b.id = bt.blog_id
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            LEFT JOIN tags t ON bt.tags_id = t.id
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            GROUP BY b.id,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                    c.id,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                    bt.blog_id
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            ORDER BY b.id WITH NO DATA;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            &#34;&#34;&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                DROP MATERIALIZED VIEW IF EXISTS mv_blogs_with_categories_and_tags_combined;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            &#34;&#34;&#34;</span>,
</span></span><span style=display:flex><span>        ),
</span></span><span style=display:flex><span>        migrations<span style=color:#f92672>.</span>RunSQL(
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            REFRESH MATERIALIZED VIEW mv_blogs_with_categories_and_tags_combined;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            &#34;&#34;&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            REFRESH MATERIALIZED VIEW mv_blogs_with_categories_and_tags_combined;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            &#34;&#34;&#34;</span>,
</span></span><span style=display:flex><span>        ),
</span></span><span style=display:flex><span>        migrations<span style=color:#f92672>.</span>RunSQL(
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            CREATE UNIQUE INDEX idx_mv_blogs_with_categories_and_tags_combined_id ON mv_blogs_with_categories_and_tags_combined (id);
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            &#34;&#34;&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            DROP INDEX IF EXISTS idx_mv_blogs_with_categories_and_tags_combined_id
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            &#34;&#34;&#34;</span>,
</span></span><span style=display:flex><span>        ),
</span></span><span style=display:flex><span>    ]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># RunSQL allows you to write code for migrating forwards and backwards</span>
</span></span><span style=display:flex><span><span style=color:#75715e># i.e, applying migrations and unapplying them. here</span>
</span></span><span style=display:flex><span><span style=color:#75715e># the first string in RunSQL is the forward SQL, the second is the reverse SQL</span>
</span></span></code></pre></div><p>Once you have added the SQL commands, run <code>python manage.py migrate</code> this will apply the migrations to the database.</p><p>After this create model, which reflects the materialized view</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>BlogsWithCategoriesAndTagsCombined</span>(models<span style=color:#f92672>.</span>Model):
</span></span><span style=display:flex><span>    id <span style=color:#f92672>=</span> models<span style=color:#f92672>.</span>IntegerField(primary_key<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>)
</span></span><span style=display:flex><span>    blog_title <span style=color:#f92672>=</span> models<span style=color:#f92672>.</span>CharField(max_length<span style=color:#f92672>=</span><span style=color:#ae81ff>200</span>, unique<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>)
</span></span><span style=display:flex><span>    blog_content <span style=color:#f92672>=</span> models<span style=color:#f92672>.</span>TextField()
</span></span><span style=display:flex><span>    blog_created_at <span style=color:#f92672>=</span> models<span style=color:#f92672>.</span>DateTimeField()
</span></span><span style=display:flex><span>    blog_is_published <span style=color:#f92672>=</span> models<span style=color:#f92672>.</span>BooleanField()
</span></span><span style=display:flex><span>    category_id <span style=color:#f92672>=</span> models<span style=color:#f92672>.</span>IntegerField()
</span></span><span style=display:flex><span>    category_name <span style=color:#f92672>=</span> models<span style=color:#f92672>.</span>CharField(max_length<span style=color:#f92672>=</span><span style=color:#ae81ff>200</span>)
</span></span><span style=display:flex><span>    tag_count <span style=color:#f92672>=</span> models<span style=color:#f92672>.</span>IntegerField()
</span></span><span style=display:flex><span>    tags <span style=color:#f92672>=</span> models<span style=color:#f92672>.</span>JSONField()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Meta</span>:
</span></span><span style=display:flex><span>        managed <span style=color:#f92672>=</span> <span style=color:#66d9ef>False</span>
</span></span><span style=display:flex><span>        db_table <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;mv_blogs_with_categories_and_tags_combined&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __str__(self):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> self<span style=color:#f92672>.</span>blog_title
</span></span></code></pre></div><p>Notice the meta class here, it has <code>managed = False</code> , this tells django to not create the table for this model in the database.</p><p>Once this is done, querying it is as simple as</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>
</span></span><span style=display:flex><span>queryset <span style=color:#f92672>=</span> BlogsWithCategoriesAndTagsCombined<span style=color:#f92672>.</span>objects<span style=color:#f92672>.</span>all()
</span></span></code></pre></div><p>Since materialized views rely on the tables for the data, when a table updates, we&rsquo;ll have to manually refresh the materialized views, this can be done inside a <strong>cron</strong> job using <strong>django-crontab</strong> or <strong>celery</strong>.</p></div></article></div><footer class=footer><div class=footer__inner><a href=/ class=logo style=text-decoration:none><span class=logo__mark><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg></span><span class=logo__text>developer</span>
<span class=logo__cursor></span></a><div class=copyright><span>© 2023 Powered by <a href=https://gohugo.io target=_blank rel=noopener>Hugo</a></span>
<span><a href=https://github.com/panr/hugo-theme-hello-friend target=_blank>Theme</a> made by <a href=https://github.com/panr target=_blank>panr</a></span></div></div></footer><script type=text/javascript src=/bundle.min.js></script></div><script async src="https://www.googletagmanager.com/gtag/js?id=G-Z1YJ2MMRYT"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-Z1YJ2MMRYT",{anonymize_ip:!1})}</script></body></html>